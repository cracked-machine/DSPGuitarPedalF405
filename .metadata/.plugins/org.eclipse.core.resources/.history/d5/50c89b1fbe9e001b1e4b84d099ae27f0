/*
 * AbstractTaskManager.hpp
 *
 *  Created on: Apr 16, 2021
 *      Author: chris
 */

#ifndef FREERTOS_ABSTRACTTASKMANAGER_HPP_
#define FREERTOS_ABSTRACTTASKMANAGER_HPP_

// FreeRTOS
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"

typedef void (*AbstractTaskPtr_t)(void*);

template<class T>
class AbstractTaskManager
{
public:
	AbstractTaskManager()
	{
		theTaskHandle = NULL;
	}

	void initTask(		const char* _taskname,
						AbstractTaskPtr_t taskptr
	);
	void initQueue();

	TaskHandle_t getTask();
	QueueHandle_t getQueue();

	void queueSendFromISR_wrapper(T item);

private:
	// static RTOS task
	TaskHandle_t theTaskHandle;
	StaticTask_t theTaskBuffer;
	StackType_t theTaskStack[ 200 ];

	// static RTOS queue for ISR-to-task comm
	uint8_t theQueueStorageArea[ 1 * sizeof( T ) ];
	QueueHandle_t theQueue;
};

template<class T>
void AbstractTaskManager<T>::initTask(	const char* _taskname,
										AbstractTaskPtr_t taskptr)
{
	// Create the task without using any dynamic memory allocation.
	theTaskHandle = xTaskCreateStatic(
		taskptr,       		// global function in ExtCtrlTaskManager
		_taskname,          	// Text name for the task.
		200,      				// Number of indexes in the ISRTaskStack array.
		this,    				// pointer to this class instance (used by "IRSTaskMan" to access class members)
		tskIDLE_PRIORITY,		// Priority at which the task is created.
		theTaskStack,           // Array to use as the task's stack.
		&theTaskBuffer );  		// Variable to hold the task's data structure.
}

typedef AbstractTaskManager<uint8_t> I2STaskManager_t;
typedef AbstractTaskManager<uint16_t> ExtCtrlManager_t;


#endif /* FREERTOS_ABSTRACTTASKMANAGER_HPP_ */
